<%- include('../partials/header',{user}) %>
<main>
    <div class="jumbotron" style="min-height:600px; margin-bottom:0;">
        <h1 class="display-4"><%=product.name%></h1>
        <h2 class="display-6" style="color:grey"><%=product.price%>$</h2>
        <hr class="my-4">
        <div style="display:flex; justify-content: space-between; margin-bottom:15px">
            <p><%=product.description%></p>
            <img src=<%=product.imageUrl%> alt="..." class="img-thumbnail" style="height:200px; width:200px">
        </div>
        <hr class="my-4">
        <h2 class="display-6" style="color:grey">Sales</h2>
        <div style="display:flex; justify-content: space-between; margin-bottom:15px">
            <div id="saleRules" style="padding-left:10px">

            </div>
        </div>
        <hr class="my-4">
        <h2 class="display-6" style="color:grey">Buying Rules</h2>
        <div style="display:flex; justify-content: space-between; margin-bottom:15px">
            <div id="purchaseRules" style="padding-left:10px">

            </div>
        </div>
        <hr class="my-4">
        <form class="form-inline" onsubmit="onSubmitAdd2Cart(event)">
            <input type="submit" class="btn btn-primary btn-lg" href="#" value="Add to Cart"/> 
            <input type="number" class="form-control"  name="amount" id="amount" placeholder="0" style="width:70px; height:50px; margin-left: 20px" />
            <p id="add2Cart-error"></p>
        </form>
    </div>
</main>
<footer>
    <%# include ../partials/footer %>
</footer>

<script>
    function onSubmitAdd2Cart(event){
        event.preventDefault();
        var amount = $("#amount").val();
        var productId= "<%=product.id%>";
        if(amount<=0){
             $("#add2Cart-error").text("Amount is not valid");
             return;
        }
        postData(`/usersApi/addProductToCart`, {amount,productId})
        .then(data => {
            if(data.status<0)
                $("#add2Cart-error").text(data.err);
            else
                document.location.href = '/carts';
            
        }) // JSON-string from `response.json()` call
        .catch(error => console.error(error));
    };


    $().ready(onStart);

    function onStart(){
        
        postData(`/storesApi/<%=product.storeId%>/purchaseRules`, {product:"<%=product.id%>"})
        .then(data => {
            if(data.status<0)
                $("#register-error").text(data.err);
            else{
                data.purchaseRules.forEach((rule,ind) => {
                    appendPurchaseRule(rule,"#purchaseRules",ind);
                });
            }
            
        }) // JSON-string from `response.json()` call
        .catch(error => console.error(error));

         postData(`/storesApi/<%=product.storeId%>/saleRules`, {product:"<%=product.id%>"})
        .then(data => {
            if(data.status<0)
                $("#register-error").text(data.err);
            else{
                data.saleRules.forEach((saleRule,ind) => {
                    appendSaleRule(saleRule,"#saleRules",ind);
                });
            }
            
        }) // JSON-string from `response.json()` call
        .catch(error => console.error(error));
    };

     function appendSaleRule(saleRule,parentId,ind){
        $(parentId).append(`
        <div>
            <span class="clickable" id="t-${saleRule.id}" onclick="toggleItem(this.id)"><i class="far fa-gem ic-w mx-1"></i>${saleRule.name}</span>
            <ul class="rule" id="${saleRule.id}" style="display:${ind!==0?'none':'block'}">
                <div>
                    <span class="clickable" id="t-${saleRule.condition.id}" onclick="toggleItem(this.id)"><i class="far fa-circle ic-w mx-1"></i>Condition</span>
                    <ul class="condition" id="${saleRule.condition.id}">
                        ${appendCondition(saleRule.condition)}
                    </ul>
                </div>
                <div>
                <span class="clickable" id="t-d${saleRule.id}" onclick="toggleItem(this.id)"><i class="far fa-circle ic-w mx-1"></i>Discounts</span>
                <ul class="condition" id="d${saleRule.id}">
                    ${appendDiscounts(saleRule.discounts)}
                </ul>
                </div>
            </ul>
        </div>
        `);
    }


    function appendDiscounts(discounts){
        return discounts.reduce((str,discount) => str+appendDiscount(discount),'');
    }

    function appendDiscount(discount){
        const productsList = discount.products.reduce((str,product)=>str+
            `<li class="clickable">
                    <i class="fas fa-desktop ic-w mr-1"></i>
                    ${product.name}
                    <a href="/products/${product.id}"><i class="fas fa-external-link-alt ic-w mx-1"></i></a>
            </li>`,'');
        return `<span class="clickable" id="t-${discount.id}" onclick="toggleItem(this.id)"><i class="far fa-circle ic-w mx-1"></i>${discount.displayText}</span>
                <ul class="condition" id="${discount.id}">
                   ${productsList}
                </ul>`
    }

    function appendPurchaseRule(rule,parentId,ind){
        $(parentId).append(`
        <div>
            <span class="clickable" id="t-${rule.id}" onclick="toggleItem(this.id)"><i class="far fa-gem ic-w mx-1"></i>${rule.name}</span>
            <ul class="rule" id="${rule.id}" style="display:${ind!==0?'none':'block'}">
                ${appendCondition(rule.condition)}
            </ul>
        </div>
        `);
    }

    function appendCondition(condition){
        if(condition.type == 'complex'){
            return `
                <span class="clickable" id="t-${condition.id}" onclick="toggleItem(this.id)"><i class="far fa-circle ic-w mx-1"></i>${condition.displayText}</span>
                <ul class="condition" id="${condition.id}">
                    ${appendCondition(condition.op1)}
                    ${appendCondition(condition.op2)}
                </ul>
            `;
        }else
        console.log(condition.product);
        return`<li class="clickable" id="#${condition.id}">
                    <i class="fas fa-desktop ic-w mr-1"></i>
                    ${condition.displayText}
                    ${condition.product?`<a href="/products/${condition.product}"><i class="fas fa-external-link-alt ic-w mx-1"></i></a>`:''}
                </li>
            `; 
        
    };
    
    function toggleItem(id){
        $('#'+id.slice(2)).toggle();
    };


</script>

</body>
</html>